import requests

from common.handle_database import Database


def group_list(l1):
    l2 = []
    for goods in l1:
        if goods not in l2:
            l2.append(goods)
    return l2


def detail_page_colors(goods_id):
    li = []
    header = {"Content-Type": "application/json",
              "Accept": "application/json",
              "x-app": "pc",
              "x-token": "",
              "x-project": "azazie",
              "x-countryCode": "US",
              "authorization": "Basic bGViYmF5OnBhc3N3MHJk"
              }
    url = f'https://apix-p6.azazie.com/1.0/product/first-screen?goods_id={goods_id}'
    res = requests.get(url, headers=header)
    colors = res.json()['data']['styleInfo']['color']
    goods_name = res.json()['data']['baseInfo']['goodsName']
    new_goods_name = goods_name.replace("Flower Girl Dress", "").strip()
    try:
        for k, _ in colors.items():
            li.append(k)
        return len(li), new_goods_name
    except Exception:
        print(f'数据异常 id:{goods_id}')


def group_goods(url, page_numbers, datas):
    """
    列表页接口返回数据 判断列表goods是否有重复
    :return:
    """
    headers = {"Content-Type": "application/json",
               "Accept": "application/json",
               "x-app": "pc",
               "x-languageCode": "en",
               "x-project": "azazie",
               "x-countryCode": "US",
               "cache-action": "flush",
               }

    goods_list = []
    for number in range(*page_numbers):
        url_with_page = url.replace("page=1", f"page={number}")
        res = requests.post(url_with_page, json=datas, headers=headers)
        dict1 = res.json()['data']['prodList']
        for item in dict1:
            goods_list.append(item['goodsId'])
    no_duplicates = group_list(goods_list)
    print(f"Total number of goods: {len(goods_list)}")
    print(goods_list)
    for item_id in no_duplicates:
        count_color_number = detail_page_colors(item_id)
        indexes_of_1 = [index for index, value in enumerate(goods_list) if value == item_id]
        print(
            f"Item ID: {item_id}, Count_goods: {goods_list.count(item_id)},count_color_number：{count_color_number[0]}",
            indexes_of_1, count_color_number[1])
    return goods_list


def az_database():
    """
    AZ数据库获取数据 处理
    :return:
    """
    header = {"Content-Type": "application/json",
              "Accept": "application/json",
              "Connection": "keep-alive",
              "Host": "audit-az.gaoyaya.com",
              "Origin": "https://audit-az.gaoyaya.com",
              "Referer": "https://audit-az.gaoyaya.com/",
              "authorization": "Basic bGViYmF5OnBhc3N3MHJk"
              }

    datas = {
        "sql": "select * from goods_display_order_brother  where effective_cat_id = 7  order by sales_order_28_days DESC ",
        "basename": "azazie", "source": "azdbslave"}
    goods_list = []
    url = 'https://audit-az.gaoyaya.com/api/v2/query'
    res = requests.post(url, headers=header, json=datas)


"""

"""


def update_order_info():
    """
    更改order_info的language & country
    国家表 ：region
    语言表：language表
    :return:
    """
    country_list = {
        "us_en": [3859, 1],
        "us_es": [3859, 3],
        "fr": [4003, 4],
        "de": [4017, 2],
        "es": [4143, 3],
        "it": [4056, 7],
        "nl": [4099, 12],
        "se": [4202, 5]}
    az_db = Database(
        user='azazie',
        password='azazie',
        host='db-zt.opsfun.com',
        port=3306,
        database='azazie'

    )
    for k, v in country_list.items():
        print(k, v)
        sql = f"UPDATE order_info SET country = {v[0]}, language_id = {v[1]} WHERE order_sn ='ZZ4577727150';"
        az_db.alter_data(sql)

        while True:
            value = input('next ??:')
            if value == 'y':
                break
            else:
                continue


flower_url = 'https://p6.azazie.com/pre/1.0/list/content?format=list&cat_name=collection-modest-bridesmaid-dresses&dress_type=dress&page=1&limit=60&in_stock=&category=collection-modest-bridesmaid-dresses&sort_by=popularity&is_outlet=0&version=b&activityVerison=b&galleryVersion=A&sodGalleryVersion=B&topic=azazie&listColorVersion=A&landingpage=tea-party-dresses&isCollectionActivity=true&supportCustomSort=0'
flower_datas = {"filters": {}, "view_mode": ["petite"],
                "originUrl": "/collection/eventshop/tea-party-dresses?category=collection-modest-bridesmaid-dresses&sort_by=popularity&page=1",
                "catIds": "7,158,3110,3",
                "goodsIds": "1060069,1056569,1060030,1060045,1056583,1052925,1052909,1052842,1052818,1052673,1052642,1052643,1034961,1034941,1009675,1009659,1005281,1005290,1003275,1002420,1002418,1001706,1001920,1001218,1001196,1001186,1001176,1000693,1000584,1000137,1000023,1064032,1064026,1064012,1064029,1064033,1064020,1064013,1064017,1064042,1003387,1003818,1005176,1005214,1005221,1005246,1005248,1005249,1005251,1005252,1005254,1005255,1005256,1005258,1005264,1005268,1005350,1005353,1005354,1005355,1005356,1005357,1005359,1005362,1005363,1005364,1005367,1005368,1005369,1005370,1005371,1005372,1005373,1005375,1005377,1005378,1005380,1005382,1005385,1005400,1005402,1005405,1005407,1005417,1005420,1005426,1005428,1005429,1005430,1005431,1005432,1005433,1005434,1005435,1005436,1005437,1005438,1005439,1005440,1005441,1005442,1005443,1005444,1005445,1005446,1005447,1005448,1005449,1005450,1005451,1005452,1005453,1005454,1005456,1005457,1005458,1005459,1005460,1005461,1005462,1005463,1005464,1005465,1005466,1005467,1005468,1005469,1005470,1005471,1005472,1005473,1005474,1005475,1005476,1005477,1005478,1005480,1005481,1005482,1005485,1005486,1005487,1005488,1005490,1005491,1005492,1005493,1005494,1005496,1005497,1005498,1005499,1005500,1005501,1005502,1005614,1005615,1005616,1005617,1005618,1005619,1005620,1005621,1005622,1005623,1005624,1005625,1005627,1005628,1005629,1005630,1005631,1005632,1005633,1005634,1005635,1005637,1005638,1005639,1005640,1005641,1005642,1005643,1005644,1005645,1005646,1005647,1005648,1005649,1005650,1005651,1005652,1005654,1005655,1005657,1005659,1005661,1005662,1005663,1005857,1005858,1005859,1005860,1005861,1005863,1005864,1005865,1005866,1005867,1005868,1005869,1005870,1005871,1005872,1005873,1005874,1005877,1005878,1005880,1005882,1005883,1005884,1005885,1005886,1005889,1005890,1005891,1005893,1005894,1005896,1005897,1005898,1005899,1005900,1005901,1005902,1005903,1005904,1005906,1005908,1005911,1005912,1005913,1005914,1005915,1005916,1005917,1005918,1005919,1005920,1005921,1005922,1005923,1005924,1005925,1005928,1005929,1005930,1005931,1005932,1005933,1005935,1005939,1005942,1005943,1005944,1005946,1005947,1005948,1005949,1005950,1005951,1005952,1005953,1005954,1005955,1005956,1006024,1006025,1006961,1006962,1006963,1006965,1006966,1006967,1006968,1006969,1006970,1006971,1006972,1006973,1006974,1006975,1006976,1006977,1006978,1006979,1006980,1006981,1006982,1006983,1006984,1006986,1006987,1006989,1006990,1006991,1006992,1006993,1006994,1006996,1006997,1006998,1006999,1007000,1007001,1007002,1007003,1007004,1007005,1007006,1007007,1007008,1007009,1007010,1007011,1007012,1007013,1007014,1007015,1007016,1007017,1007019,1007020,1007021,1007022,1007023,1007024,1007025,1007026,1007027,1007028,1007029,1007030,1007031,1007032,1007033,1007034,1007035,1007036,1007037,1007038,1007039,1007040,1007041,1007042,1007043,1007044,1007045,1007046,1007047,1007048,1007049,1007050,1007051,1007052,1007053,1007054,1007055,1007056,1007057,1007058,1007059,1007060,1007628,1007629,1007630,1007634,1007637,1007638,1007641,1007642,1007645,1007649,1007651,1007652,1007653,1007656,1007657,1007658,1007659,1007660,1007664,1007665,1007669,1007671,1007675,1007676,1007678,1007679,1007680,1007681,1007683,1007707,1007708,1007711,1007712,1007713,1007715,1007716,1007717,1007718,1007722,1007725,1007726,1007727,1007728,1007729,1007738,1007739,1007740,1008125,1008185,1008186,1008188,1008189,1008193,1053980,1053981,1053983,1054076,1054078,1054079,1054082,1055311,1055313,1055322,1055817,1055819,1055820,1056006,1056012,1056021,1056030,1056031,1056033,1056035,1056042,1056060,1056061,1056063,1056161,1056183,1056247,1056333,1056388,1056394,1056690,1056797,1056799,1056804,1056810,1056849,1056856,1056867,1056924,1056927,1056932,1057047,1057064,1057166,1057293,1057305,1057729,1057735,1057863,1057872,1057874,1057876,1057878,1057880,1057887,1057891,1057910,1057920,1057929,1057930,1057931,1057935,1057941,1057958,1057984,1057985,1057998,1057999,1058000,1058001,1058002,1058006,1058007,1058008,1058009,1058010,1058262,1058263,1058264,1058266,1058270,1058317,1058398,1058414,1058428,1058496,1058513,1058524,1058529,1058533,1058560,1058565,1058615,1058617,1058621,1058629,1058644,1058676,1058679,1058693,1058694,1058713,1058714,1058734,1058784,1058794,1058802,1059020,1059026,1059027,1059030,1059048,1059063,1059079,1059084,1059152,1059210,1059238,1059246,1059247,1059255,1059275,1059521,1059528,1059539,1059545,1059550,1059554,1059561,1059581,1059608,1059616,1059617,1059713,1059716,1059760,1059763,1059772,1059786,1059792,1059811,1059826,1059835,1059948,1059950,1060738,1060743,1060746,1060769,1060773,1060808,1060821,1060854,1060876,1060878,1060947,1061114,1061138,1061139,1061180,1061181,1061184,1061252,1061310,1061504,1061564,1061709,1061710,1061802,1061811,1061847,1061851,1061938,1062147,1062170,1062196,1062339,1062345,1062363,1062364,1062388,1062392,1062413,1062427,1062947"}
group_goods(flower_url, (1, 6), flower_datas)

# detail_page_colors(1000291)
